name: Security Scans

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # Static Application Security Testing (SAST)
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: ['python', 'javascript']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  semgrep-scan:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Semgrep
        run: |
          semgrep scan --config auto \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/secrets \
            --sarif -o semgrep-results.sarif
      
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep-results.sarif

  # Dependency Scanning
  dependency-scan-python:
    name: Python Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install safety bandit
          pip install -r requirements.txt
      
      - name: Run Safety check
        run: |
          cd backend
          safety check --json --output safety-report.json || true
          cat safety-report.json
      
      - name: Run Bandit
        run: |
          cd backend
          bandit -r app/ -f json -o bandit-report.json || true
          cat bandit-report.json
      
      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-reports
          path: |
            backend/safety-report.json
            backend/bandit-report.json

  dependency-scan-npm:
    name: NPM Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run npm audit
        run: |
          cd frontend
          npm audit --json > npm-audit-report.json || true
          cat npm-audit-report.json
      
      - name: Upload npm audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: frontend/npm-audit-report.json

  snyk-scan:
    name: Snyk Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'  # Skip on scheduled runs to avoid rate limits
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Snyk to check for vulnerabilities (Python)
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=backend/requirements.txt --severity-threshold=high
      
      - name: Run Snyk to check for vulnerabilities (NPM)
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=frontend/package.json --severity-threshold=high

  # Container Image Scanning
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build backend Docker image
        run: |
          cd backend
          docker build -t pubsec-backend:${{ github.sha }} .
      
      - name: Build frontend Docker image
        run: |
          docker build -f Dockerfile.frontend -t pubsec-frontend:${{ github.sha }} .
      
      - name: Run Trivy scan on backend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: pubsec-backend:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Run Trivy scan on frontend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: pubsec-frontend:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: |
            trivy-backend-results.sarif
            trivy-frontend-results.sarif

  # Secret Scanning
  trufflehog-scan:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning
      
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # Dynamic Application Security Testing (DAST) - placeholder
  # Requires running application, typically run in staging environment
  zap-scan:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Manual trigger only
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start application stack
        run: |
          docker-compose up -d
          # Wait for services to be ready
          sleep 30
      
      - name: Run ZAP baseline scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
      
      - name: Stop application stack
        if: always()
        run: docker-compose down

  # Security summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, semgrep-scan, dependency-scan-python, dependency-scan-npm, trivy-scan, trufflehog-scan]
    if: always()
    
    steps:
      - name: Security scan complete
        run: |
          echo "Security scans completed. Review results in Security tab."
          echo "Jobs status:"
          echo "- CodeQL: ${{ needs.codeql-analysis.result }}"
          echo "- Semgrep: ${{ needs.semgrep-scan.result }}"
          echo "- Python deps: ${{ needs.dependency-scan-python.result }}"
          echo "- NPM deps: ${{ needs.dependency-scan-npm.result }}"
          echo "- Trivy: ${{ needs.trivy-scan.result }}"
          echo "- TruffleHog: ${{ needs.trufflehog-scan.result }}"
